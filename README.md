# INOTIFY-AGENT

Агент сообщений от inotify, предназначенный для отправки указанных событий
файловой системы в очереди amqp или топики mqtt. 

Количество серверов и очередей не ограничено, брокеры могут располагаться как
локально, так и на удаленных машинах.

## Использование
Перед запуском, активировать виртуальное окружение из папки с проектом:

`source venv/bin/activate`

Для запуска следует использовать команду:

`python -m agent`

По умолчанию траснпорт ищет файл конфигурации bindings.ini
в текущей рабочей директории. Можно изменить путь к файлу конфигурции, 
воспользовавшись переменной окружения BINDINGS_CONF:

`BINDINGS_CONF=some/path/bindings.ini python -m agent`

Файл конфигурации записывается в формате .ini:
https://docs.python.org/3/library/configparser.html#supported-ini-file-structure

Пример полного файла с настройками содержится в корне проекта 
с именем bindings_example.ini.

Также агент ищет в текущей рабочей директории файл конфигурации 
логгирования - logging.ini. Если файл не существует, то логи будут выводиться
в только консоль и с уровнем INFO. Путь к файлу конфигурации логов можно 
задать с помощью переменной окружения LOGGING_CONF. Файл конфигурации логов
задается в стандартном для Python logging виде:
https://docs.python.org/3/howto/logging.html#configuring-logging


## Конфигурирование



### brokers
Эта секция содержит ключ names, в котором указываются имена секций,
описывающих конкретные брокеры. Для каждого имени, указанного в names, должна
быть описана секция с названием [{broker_name}_broker].

Например:

```
    [brokers]
    names = first,second

    [first_broker]
    ...

    [remote_broker]
    ...
```

Секция, описывающая брокер, должна содержать следующие значения:


#### Общие для всех типов брокеров:

broker_protocol: имя протокола для брокера. Может быть mqtt, amqp.

broker_host: адрес брокера.

broker_password: пароль для входа.

publisher_check_interval: интервал, с которым будет проверяться доступность 
соединения с брокером для отправки, в секундах.


#### Настройки для AMQP:

broker_virtual_host: имя виртуального хоста.

ssl: использовать ли шифрование при подключении (True/False)
broker_login: логин для входа.


#### Настройки для MQTT:

Для протокола MQTT нет специфичных настроек.


### Bindings

Эта секция содержит ключ names, в котором указываются имена секций,
описывающих биндинги очередей. Для каждого имени, указанного в names, должна
быть описана секция с названием [binding_{binding_name}].

## Установка скриптом

```
    /usr/bin/env bash install.sh
```

## Установка ручная

После клонирования репозитория следует установить зависимости и  создать виртуальное окружение:
```
    sudo apt install python3.8
    sudo apt-get install python3.8-dev

    virtualenv -p python3.8 venv
    source venv/bin/activate
    pip install -e .

```

## Установка для разработки:

После клонирования репозитория следует создать виртуальное окружение:

```
    sudo apt install python3.8
    sudo apt-get install python3.8-dev
    virtualenv -p python3.8 venv
    source venv/bin/activate
```
Далее из корня проекта следует выполнить:

`pip install -e .[dev]`

Cоздать логфайл в соответствии с настройками в bindings.ini

`mkdir tmp`
`touch tmp/some_name.log`

На этом установка закончена.
